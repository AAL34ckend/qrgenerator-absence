<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator QR Code Absensi Toko</title>
    <!-- Tailwind CSS CDN untuk styling yang modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font "Inter" untuk tampilan yang bersih -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }
    </style>
  </head>
  <body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen text-gray-800">
    <div id="loadingOverlay" class="fixed top-0 left-0 right-0 bottom-0 bg-gray-900 bg-opacity-70 flex flex-col justify-center items-center text-white text-2xl z-50 hidden transition-opacity duration-300">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
      Menyiapkan unduhan...
    </div>

    <div class="container bg-white p-6 sm:p-10 rounded-xl shadow-lg w-full max-w-lg">
      <h1 class="text-3xl sm:text-4xl font-bold text-center text-blue-600 mb-6">Generator QR Code Absensi Toko</h1>

      <!-- Status Message Area -->
      <div id="statusMessage" class="hidden p-3 rounded-lg text-center mb-4 transition-all duration-300"></div>

      <label for="storeSelect" class="block text-sm font-semibold mb-2">Pilih Toko:</label>
      <select id="storeSelect" class="w-full p-3 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="" disabled selected>Memuat daftar toko...</option>
      </select>
      
      <p class="loading-message text-center text-gray-500 italic" id="loadingMessage"></p>

      <button onclick="downloadAllQRCodes()" class="w-full mt-4 p-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105">
        Download Semua QR Code
      </button>

      <button onclick="generateQrCode()" class="w-full mt-4 p-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-300 transform hover:scale-105">
        Buat QR Code
      </button>

      <div id="outputUrl" class="mt-6 p-4 bg-gray-100 border border-gray-200 rounded-lg word-break-all text-sm">
        <p>URL akan muncul di sini.</p>
      </div>

      <div id="qr-code-container" class="mt-6 text-center">
        <p>QR Code akan muncul di bawah ini.</p>
        <div id="qrcode" class="mt-4 flex justify-center"></div>
      </div>
    </div>

    <!-- Pustaka JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
      // GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
      const appsScriptUrl = "https://script.google.com/macros/s/AKfycbz9rczn07E29LnlK_hT1XizTHm7V_bZnqOq8Cevd0fjNFg7JO63-aSmnCmXTX_kjw9t0g/exec";
      
      // Mengubah URL tujuan QR Code menjadi URL Apps Script itu sendiri
      const githubPageUrl = appsScriptUrl;

      // Fungsi untuk menampilkan pesan status (menggantikan alert)
      function showStatusMessage(message, type = 'info') {
          const statusDiv = document.getElementById("statusMessage");
          statusDiv.textContent = message;
          statusDiv.className = 'p-3 rounded-lg text-center mb-4 transition-all duration-300'; // Reset kelas
          if (type === 'success') {
              statusDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
          } else if (type === 'error') {
              statusDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
          } else { // info
              statusDiv.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
          }
          statusDiv.classList.remove('hidden');
      }

      window.onload = function() {
        fetchStoresAndPopulateDropdown();
      };
      
      async function fetchStoresAndPopulateDropdown() {
        const storeSelect = document.getElementById("storeSelect");
        const loadingMessage = document.getElementById("loadingMessage");
        
        loadingMessage.innerText = "Mengambil data toko...";
        
        try {
          // Perbaikan: Menambahkan parameter `page=data` agar cocok dengan fungsi doGet()
          const response = await fetch(`${appsScriptUrl}?page=data&storeId=all`); 
          
          if (!response.ok) {
            throw new Error(`Kesalahan Jaringan: ${response.status} ${response.statusText}`);
          }
          
          const stores = await response.json();
          console.log("Respons Apps Script (objek JSON):", stores);
          
          if (!Array.isArray(stores)) {
              throw new Error("Respons Apps Script bukan array JSON.");
          }
          
          if (stores.length === 0) {
            storeSelect.innerHTML = '<option value="" disabled selected>Tidak ada data toko.</option>';
            loadingMessage.innerText = "";
            showStatusMessage("Tidak ada data toko yang ditemukan.", "info");
            return;
          }
          
          storeSelect.innerHTML = '';
          storeSelect.disabled = false;
          
          stores.forEach(store => {
            if (store.id && store.name) {
              const option = document.createElement("option");
              option.value = store.id;
              option.text = store.name + ' (' + store.id + ')';
              storeSelect.appendChild(option);
            }
          });
          
          loadingMessage.innerText = "";
          
        } catch (error) {
          console.error("Kesalahan saat mengambil data:", error);
          storeSelect.innerHTML = '<option value="" disabled selected>Error: Gagal memuat data.</option>';
          loadingMessage.innerText = `Error: Gagal memuat data toko. ${error.message}`;
          storeSelect.disabled = true;
          // Pesan yang lebih spesifik untuk membantu pengguna
          showStatusMessage(`Gagal memuat data toko. Ini mungkin disebabkan oleh masalah dengan URL Apps Script atau izinnya. Pastikan URL Web App sudah benar dan di-deploy dengan izin yang sesuai ("Siapa saja" atau "Siapa saja, bahkan anonim").`, "error");
        }
      }

      function generateQrCode() {
        const storeSelect = document.getElementById("storeSelect");
        const storeId = storeSelect.value;
        
        if (!storeId) {
          showStatusMessage("Silakan pilih toko terlebih dahulu.", "error");
          return;
        }

        // Sembunyikan pesan status sebelumnya
        document.getElementById("statusMessage").classList.add("hidden");

        const fullUrl = `${githubPageUrl}?storeId=${storeId}`;

        const outputDiv = document.getElementById("outputUrl");
        outputDiv.innerHTML = `<p><b>URL QR Code:</b></p><p>${fullUrl}</p>`;

        document.getElementById("qrcode").innerHTML = "";

        new QRCode(document.getElementById("qrcode"), {
          text: fullUrl,
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });
        showStatusMessage("QR Code berhasil dibuat!", "success");
      }

      async function downloadAllQRCodes() {
        const storeSelect = document.getElementById("storeSelect");
        const options = storeSelect.options;
        
        if (options.length === 0) {
          showStatusMessage("Belum ada data toko untuk dibuat QR Code.", "error");
          return;
        }
        
        const overlay = document.getElementById("loadingOverlay");
        overlay.classList.remove("hidden"); // Tampilkan loading
        
        const zip = new JSZip();
        
        for (let i = 0; i < options.length; i++) {
          const storeId = options[i].value;
          const storeName = options[i].text;
          if (!storeId) continue;
        
          const fullUrl = `${githubPageUrl}?storeId=${storeId}`;
        
          const qrContainer = document.createElement("div");
          new QRCode(qrContainer, {
            text: fullUrl,
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
          });
        
          // Tunggu QR Code di-render.
          // Ini adalah solusi sementara; idealnya, gunakan callback `onrender` jika pustaka mendukungnya.
          await new Promise(resolve => setTimeout(resolve, 500));
        
          const img = qrContainer.querySelector("img");
          if (img) {
            const base64Data = img.src.split(",")[1];
        
            const safeName = storeName.split("(")[0].trim().toUpperCase().replace(/[^A-Z0-9]/g, "_");
            const fileName = `${safeName}.png`;
        
            zip.file(fileName, base64Data, { base64: true });
          }
        
          qrContainer.innerHTML = "";
        }
        
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, "ALL_QR_CODES.zip");

        overlay.classList.add("hidden"); // Sembunyikan loading
        showStatusMessage("âœ… Semua QR Code berhasil diunduh dalam 1 file ZIP!", "success");
      }
    </script>
  </body>
</html>
